<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regulatory Risk Radar - Datathon 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .risk-critical { color: #dc3545; }
        .risk-high { color: #fd7e14; }
        .risk-medium { color: #ffc107; }
        .risk-low { color: #198754; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-5px); }
        .loading { display: none; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line"></i> Regulatory Risk Radar
            </span>
            <span class="badge bg-success">Datathon 2025</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="fas fa-shield-alt"></i> AI-Powered Portfolio Protection</h3>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">Real-time regulatory risk analysis for S&P 500 portfolio management</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Companies</h5>
                        <h2 class="text-primary" id="total-companies">
                            <div class="loading spinner-border" role="status"></div>
                        </h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Top 10 Weight</h5>
                        <h2 class="text-info" id="top-10-weight">
                            <div class="loading spinner-border" role="status"></div>
                        </h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Tech Exposure</h5>
                        <h2 class="text-warning" id="tech-exposure">
                            <div class="loading spinner-border" role="status"></div>
                        </h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Risk Level</h5>
                        <h2 id="risk-level">
                            <div class="loading spinner-border" role="status"></div>
                        </h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-upload"></i> Upload New Regulation</h4>
                    </div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="regulation-file" name="file" 
                                               accept=".xml,.html,.pdf,.txt" required>
                                        <div class="form-text">
                                            Supported formats: XML, HTML, PDF, TXT (Max 16MB)
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-primary btn-lg w-100" id="analyze-btn">
                                        <i class="fas fa-brain"></i> Analyze Impact
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Upload Results -->
                        <div id="upload-results" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status" id="upload-spinner"></div>
                                    <span id="upload-status">Analyzing regulation...</span>
                                </div>
                            </div>
                            <div id="analysis-output" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Scenarios -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Risk Scenarios</h4>
                    </div>
                    <div class="card-body">
                        <div id="risk-scenarios">
                            <div class="text-center">
                                <div class="spinner-border" role="status"></div>
                                <p>Loading risk scenarios...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Companies -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-building"></i> Top Companies</h4>
                    </div>
                    <div class="card-body">
                        <div id="top-companies">
                            <div class="text-center">
                                <div class="spinner-border" role="status"></div>
                                <p>Loading companies...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-lightbulb"></i> Recommendations</h4>
                    </div>
                    <div class="card-body">
                        <div id="recommendations">
                            <div class="text-center">
                                <div class="spinner-border" role="status"></div>
                                <p>Loading recommendations...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Impact Calculator -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-calculator"></i> Portfolio Impact Calculator</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="portfolio-value" class="form-label">Portfolio Value ($)</label>
                                <input type="number" class="form-control" id="portfolio-value" value="1000000" min="1000" step="1000">
                                <button class="btn btn-primary mt-2" onclick="calculateImpact()">Calculate Impact</button>
                            </div>
                            <div class="col-md-8">
                                <div id="impact-results">
                                    <p class="text-muted">Enter portfolio value and click Calculate Impact</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Company Search -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-search"></i> Company Analysis</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="company-symbol" class="form-label">Company Symbol</label>
                                <input type="text" class="form-control" id="company-symbol" placeholder="e.g., NVDA" maxlength="5">
                                <button class="btn btn-info mt-2" onclick="analyzeCompany()">Analyze Company</button>
                            </div>
                            <div class="col-md-8">
                                <div id="company-results">
                                    <p class="text-muted">Enter a company symbol to analyze regulatory risk</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolioOverview();
            loadRiskScenarios();
            loadTopCompanies();
            loadRecommendations();
        });

        async function loadPortfolioOverview() {
            try {
                const response = await fetch('/api/portfolio/overview');
                const data = await response.json();
                
                document.getElementById('total-companies').innerHTML = data.total_companies;
                document.getElementById('top-10-weight').innerHTML = data.top_10_concentration;
                document.getElementById('tech-exposure').innerHTML = data.tech_concentration;
                
                const riskElement = document.getElementById('risk-level');
                riskElement.innerHTML = data.risk_level;
                riskElement.className = data.risk_level === 'HIGH' ? 'text-danger' : 'text-warning';
            } catch (error) {
                console.error('Error loading portfolio overview:', error);
            }
        }

        async function loadRiskScenarios() {
            try {
                const response = await fetch('/api/risk/scenarios');
                const scenarios = await response.json();
                
                let html = '<div class="row">';
                scenarios.forEach(scenario => {
                    const riskClass = scenario.risk_level === 'HIGH' ? 'risk-critical' : 
                                     scenario.risk_level === 'MEDIUM' ? 'risk-medium' : 'risk-low';
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${scenario.name}</h6>
                                    <h4 class="${riskClass}">${scenario.portfolio_impact}</h4>
                                    <p class="small text-muted">${scenario.description}</p>
                                    <small>Affected: ${scenario.affected_weight}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                document.getElementById('risk-scenarios').innerHTML = html;
            } catch (error) {
                console.error('Error loading risk scenarios:', error);
            }
        }

        async function loadTopCompanies() {
            try {
                const response = await fetch('/api/portfolio/top-companies');
                const companies = await response.json();
                
                let html = '<div class="list-group">';
                companies.slice(0, 8).forEach(company => {
                    const riskClass = company.risk_level === 'CRITICAL' ? 'risk-critical' : 
                                     company.risk_level === 'HIGH' ? 'risk-high' : 'risk-medium';
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${company.Symbol}</strong><br>
                                <small class="text-muted">${company.Company}</small>
                            </div>
                            <div class="text-end">
                                <span class="${riskClass}">${company.weight_formatted}</span><br>
                                <small class="${riskClass}">${company.risk_level}</small>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                document.getElementById('top-companies').innerHTML = html;
            } catch (error) {
                console.error('Error loading top companies:', error);
            }
        }

        async function loadRecommendations() {
            try {
                const response = await fetch('/api/recommendations');
                const recommendations = await response.json();
                
                let html = '<div class="list-group">';
                recommendations.forEach(rec => {
                    const priorityClass = rec.priority === 'HIGH' ? 'text-danger' : 'text-warning';
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${rec.action} ${rec.target}</h6>
                                <small class="${priorityClass}">${rec.priority}</small>
                            </div>
                            <p class="mb-1">${rec.current} â†’ ${rec.target_allocation} (${rec.change})</p>
                            <small>Timeline: ${rec.timeline}</small>
                        </div>
                    `;
                });
                html += '</div>';
                
                document.getElementById('recommendations').innerHTML = html;
            } catch (error) {
                console.error('Error loading recommendations:', error);
            }
        }

        async function calculateImpact() {
            const portfolioValue = document.getElementById('portfolio-value').value;
            
            try {
                const response = await fetch(`/api/calculate-impact?value=${portfolioValue}`);
                const data = await response.json();
                
                let html = `<h5>Portfolio Value: ${data.portfolio_value}</h5><div class="row">`;
                
                Object.entries(data.impacts).forEach(([scenario, impact]) => {
                    html += `
                        <div class="col-md-4 mb-2">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6>${scenario}</h6>
                                    <h5 class="text-danger">${impact.dollar_amount}</h5>
                                    <small class="text-muted">${impact.percentage}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div><div class="alert alert-danger mt-3">
                    <strong>Total Tech Risk: ${data.total_risk}</strong>
                </div>`;
                
                document.getElementById('impact-results').innerHTML = html;
            } catch (error) {
                console.error('Error calculating impact:', error);
            }
        }

        async function analyzeCompany() {
            const symbol = document.getElementById('company-symbol').value.toUpperCase();
            
            if (!symbol) {
                alert('Please enter a company symbol');
                return;
            }
            
            try {
                const response = await fetch(`/api/company/${symbol}`);
                const data = await response.json();
                
                if (response.ok) {
                    const riskClass = data.risk_level === 'CRITICAL' ? 'text-danger' : 
                                     data.risk_level === 'HIGH' ? 'text-warning' : 'text-success';
                    
                    const html = `
                        <div class="card">
                            <div class="card-body">
                                <h5>${data.company} (${data.symbol})</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Portfolio Weight:</strong> ${data.weight}</p>
                                        <p><strong>Price:</strong> $${data.price}</p>
                                        <p><strong>Tech Company:</strong> ${data.is_tech ? 'Yes' : 'No'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Regulatory Impact:</strong> <span class="${riskClass}">${data.regulatory_impact}</span></p>
                                        <p><strong>Risk Level:</strong> <span class="${riskClass}">${data.risk_level}</span></p>
                                        <p><strong>Recommendation:</strong> <span class="fw-bold">${data.recommendation}</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('company-results').innerHTML = html;
                } else {
                    document.getElementById('company-results').innerHTML = 
                        `<div class="alert alert-warning">Company ${symbol} not found in S&P 500</div>`;
                }
            } catch (error) {
                console.error('Error analyzing company:', error);
                document.getElementById('company-results').innerHTML = 
                    `<div class="alert alert-danger">Error analyzing company</div>`;
            }
        }

        // Allow Enter key for company search
        document.getElementById('company-symbol').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeCompany();
            }
        });

        // File upload handling
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('regulation-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading state
            document.getElementById('upload-results').style.display = 'block';
            document.getElementById('upload-spinner').style.display = 'inline-block';
            document.getElementById('upload-status').textContent = 'Analyzing regulation...';
            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('analysis-output').innerHTML = '';
            
            fetch('https://dbkteg3a3epmwcc.studio.us-west-2.sagemaker.aws/jupyterlab/default/proxy/8080/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('upload-spinner').style.display = 'none';
                document.getElementById('analyze-btn').disabled = false;
                
                if (data.success) {
                    document.getElementById('upload-status').textContent = 'Analysis completed!';
                    document.getElementById('upload-status').className = 'text-success';
                    
                    // Display results
                    document.getElementById('analysis-output').innerHTML = `
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Analysis Results</h5>
                            </div>
                            <div class="card-body">
                                <pre class="bg-light p-3 rounded">${data.results}</pre>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('upload-status').textContent = 'Analysis failed';
                    document.getElementById('upload-status').className = 'text-danger';
                    
                    document.getElementById('analysis-output').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('upload-spinner').style.display = 'none';
                document.getElementById('analyze-btn').disabled = false;
                document.getElementById('upload-status').textContent = 'Upload failed';
                document.getElementById('upload-status').className = 'text-danger';
                
                document.getElementById('analysis-output').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            });
        });
    </script>
</body>
</html>